<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Priscilla — Event Highlights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet + MarkerCluster (CDN; these are static and fine to keep, but tell me if you want them local too) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" crossorigin=""></script>

  <style>
    :root {
      --bg: #0e0f12;
      --panel: #15171c;
      --ink: #e9ecf1;
      --muted: #a9b0bd;
      --accent: #9be0ff;
      --chip: #22252d;
      --chip-ink: #d5d9e3;
      --border: #23252c;
    }
    /* Base font for this page */
body.site {
  font-family: "Aileron", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
}

/* Headings & topbar title in Bebas Neue */
h1, h2, h3, h4,
.tb-title a {
  font-family: "Bebas Neue", "Aileron", sans-serif;
  font-weight: 400;
  letter-spacing: .5px;
}

    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; }
    a { color: var(--accent); text-decoration: none; }
    a:focus { outline: 2px solid var(--accent); outline-offset: 2px; }

    body.site {
      background: var(--bg);
      color: var(--ink);
      display: grid;
      grid-template-rows: auto 1fr auto; /* top bar | content | footer */
      min-height: 100vh;
    }

    /* ===== TOP BAR (your design) ===== */
    .topbar {
      position: sticky; top: 0; z-index: 1000;
      background: #000; color: #fff; border-bottom: 1px solid #111;
    }
    .tb-wrap {
      max-width: 1200px; margin: 0 auto; padding: 10px 14px;
      display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
    }
    .tb-nav { display: flex; gap: 26px; font-weight: 600; }
    .tb-nav a { color: #fff; opacity: 0.9; }
    .tb-nav a:hover, .tb-nav a:focus { opacity: 1; }
    .tb-nav a.active { opacity: 1; }
    .tb-title a { color: #fff; font-weight: 800; font-size: 28px; letter-spacing: .01em; }
    .tb-spacer { justify-self: end; }
    @media (max-width: 820px) {
      .tb-wrap { grid-template-columns: 1fr; row-gap: 8px; }
      .tb-title { justify-self: center; }
      .tb-spacer { display: none; }
      .tb-nav { justify-content: center; flex-wrap: wrap; gap: 16px; }
      .tb-title a { font-size: 22px; }
    }

    /* ===== Layout ===== */
    .content { display: grid; grid-template-columns: 380px 1fr; min-height: 70vh; }
    @media (max-width: 900px) { .content { grid-template-columns: 1fr; grid-template-rows: 55vh 45vh; } }

    aside {
      background: var(--panel); padding: 16px 16px 24px; overflow: auto; border-right: 1px solid var(--border);
    }
    header.section h2 { font-size: 18px; margin: 0 0 4px; }
    header.section p { margin: 0; color: var(--muted); font-size: 14px; }

    .filters { display: flex; gap: 8px; margin: 12px 0 16px; flex-wrap: wrap; }
    .filters select, .filters input {
      background: #0f1116; color: var(--ink); border: 1px solid #343945; border-radius: 8px; padding: 8px 10px;
    }
    .chipbar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .chip { background: var(--chip); color: var(--chip-ink); padding: 6px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #2d313b; }
    .count { font-weight: 600; color: var(--accent); }

    .country { margin: 14px 0; }
    .country>h3 { font-size: 14px; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); margin: 12px 0 6px; }
    .city { margin: 8px 0 14px; }
    .city h4 { margin: 6px 0; font-size: 15px; display: flex; align-items: center; gap: 8px; }
    .city a.focus { font-size: 12px; color: var(--accent); }
    .event { background: #0f1116; border: 1px solid #2d313b; border-radius: 10px; padding: 8px 10px; margin: 6px 0; }
    .event small { color: var(--muted); }

    #map { width: 100%; height: calc(100vh - 64px); }
    @media (max-width: 900px) { #map { height: 100%; } }

    .leaflet-popup-content { margin: 8px; }
    .popup-title { font-weight: 700; margin-bottom: 4px; }
    .popup-event {
  margin: 6px 0;
  padding: 6px;
  border-radius: 8px;
  background: #0f1116;
  border: 1px solid #2a2e37;
  color: #fff;              /* <-- makes all text white */
}

.popup-event small {
  color: #ccc;              /* optional: slightly dim the small text */
}

    /* Country highlight styles */
    
    .site-footer { border-top: 1px solid var(--border); color: var(--muted); }
    .site-footer .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; font-size: 12px; }
  </style>

<script>
  // If the page is loaded as portfolio/event-highlights.html?embed=1
  // add a class on <html> so we can tweak layout just for the iframe version.
  (function () {
    var p = new URLSearchParams(location.search);
    if (p.get('embed') === '1') {
      document.documentElement.classList.add('is-embedded');
    }
  })();
</script>

<style>
  /* ————— Embed mode: remove site chrome & fill the iframe ————— */

  /* Let the page fill the iframe */
  html.is-embedded, 
  html.is-embedded body,
  html.is-embedded body.site { height: 100%; margin: 0 !important; min-height: 100vh; }

  /* Hide outer site chrome when embedded */
  html.is-embedded .topbar,
  html.is-embedded .site-header,
  html.is-embedded .brand,
  html.is-embedded .site-footer { display: none !important; }

  /* Our layout on this page */
  html.is-embedded .content { min-height: 100vh; }   /* the grid (sidebar + map) */
  html.is-embedded #map     { height: 100vh !important; }  /* override the -64px height */

  /* Keep the small page title above the filters VISIBLE */
  html.is-embedded header.section { display: block !important; }

  /* Let the left panel scroll independently inside the iframe */
  html.is-embedded aside { max-height: 100vh; overflow: auto; }
</style>

</head>

<body class="site">
  
  <div class="content">
    <aside>
      <header class="section">
        <h2>Event Highlights — Dance Footprint</h2>
        <p>Explore performances, competitions, and workshops by place and year.</p>
      </header>

      <div class="filters">
        <input id="search" type="search" placeholder="Search event or city…" aria-label="Search" />
        <select id="yearFilter" aria-label="Filter by year"><option value="">All years</option></select>
        <select id="roleFilter" aria-label="Filter by role"><option value="">All roles</option></select>
      </div>

      <div class="chipbar">
        <span class="chip"><span class="count" id="totalEvents">0</span> events</span>
        <span class="chip"><span class="count" id="totalCities">0</span> cities</span>
        <span class="chip"><span class="count" id="totalCountries">0</span> countries</span>
      </div>

      <div id="list"></div>
    </aside>

    <main id="map" aria-label="World map of events"></main>
  </div>

  <div class="site-footer">
    <div class="wrap">© <span id="y"></span> Priscilla — Dance & Performance</div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Footer year
    const yEl = document.getElementById('y');
    if (yEl) yEl.textContent = new Date().getFullYear();

    // ---------- EVENTS ----------
    const EVENTS = [
      { country:"Georgia", city:"Tbilisi", lat:41.7151, lng:44.8271, title:"Partner Me New Year — Contemporary, Contact Improvisation, Lift & Tricks", role:"Taught", date:"2025" },
      { country:"Georgia", city:"Tbilisi", lat:41.7151, lng:44.8271, title:"Dance with Priscilla & Alex — Contemporary, Dance Technique", role:"Taught", date:"2024" },
      { country:"Latvia", city:"Riga", lat:56.9496, lng:24.1052, title:"Dance with Priscilla — Jazz, Contemporary, Dance Technique, Contact Improv, Anatomy", role:"Taught", date:"2024" },
      { country:"Latvia", city:"Riga", lat:56.9496, lng:24.1052, title:"Riga Summer Swing by WeDance — West Coast Swing, Contemporary, Improvisation", role:"Taught", date:"2024" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"TMHMLMG - Lee Su - FEH, Five Arts Centre — Fitzmaurice Voicework", role:"Attended", date:"2024" },
      { country:"France", city:"Strasbourg", lat:48.5734, lng:7.7521, title:"Dance with Priscilla — West Coast Swing, Contemporary, Dance Technique, Contact Improv", role:"Taught", date:"2024" },
      { country:"Hungary", city:"Budapest", lat:47.4979, lng:19.0402, title:"Budafest — West Coast Swing (Level 6, Novice J&J Semifinalist, 8 heats)", role:"Competed", date:"2024" },

      { country:"Malaysia", city:"George Town (Penang)", lat:5.4141, lng:100.3288, title:"Dance Techniques & West Coast Swing Application — Intensive", role:"Taught", date:"2023" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Inner Cosmic Energy by Rupa Subramaniam feat. Priscilla J — Contemporary, Improvisation, Group work", role:"Performed", date:"2023" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"KL Social Society — Rueda", role:"Taught", date:"2023" },
      { country:"Poland", city:"Bukowina Tatrzańska", lat:49.3240, lng:20.1078, title:"Out of the Box Camp — Contemporary, Contact Improv, West Coast Swing", role:"Attended", date:"2023" },
      { country:"Poland", city:"Bukowina Tatrzańska", lat:49.3240, lng:20.1078, title:"Summer Summit — West Coast Swing (Level 5)", role:"Attended", date:"2023" },
      { country:"Poland", city:"Bukowina Tatrzańska", lat:49.3240, lng:20.1078, title:"4 Days Intensive — West Coast Swing (Fitness Instructor)", role:"Taught", date:"2023" },
      { country:"Sweden", city:"Stockholm", lat:59.3293, lng:18.0686, title:"Uptown Swing — West Coast Swing (Intermediate J&J)", role:"Competed", date:"2023" },
      { country:"Netherlands", city:"Amsterdam", lat:52.3676, lng:4.9041, title:"Viva Kizomba Congress — Kizomba (Instructor, LPK style)", role:"Taught", date:"2023" },
      { country:"Denmark", city:"Bosei Sports High School", lat:55.13264412398683, lng:12.008772543710773, title:"Cuban Salsa Summer Camp — Salsa, Bachata (Rueda Instructor)", role:"Taught", date:"2023" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Afro Latin Festival Asia — Salsa, Bachata", role:"Attended", date:"2023" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Rueda International Flashmob Day — Rueda, Cuban Salsa", role:"Taught", date:"2023" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Rueda @ The Park — Rueda, Cuban Salsa", role:"Taught", date:"2023" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Animal Flow Instructor Course (Level 1), BABEL", role:"Attended", date:"2023" },
      { country:"Singapore", city:"Singapore", lat:1.3521, lng:103.8198, title:"Asian Open — West Coast Swing (Novice J&J Semifinalist)", role:"Competed", date:"2023" },
      { country:"Singapore", city:"Singapore", lat:1.3521, lng:103.8198, title:"Afrokiz Weekender — Kizomba, Afro, UrbanKiz", role:"Attended", date:"2023" },

      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Latin American Festival — (Performer)", role:"Performed", date:"2019" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Latin American Festival", role:"Attended", date:"2022" },
      { country:"Singapore", city:"Singapore", lat:1.3521, lng:103.8198, title:"Spooky Westie Weekend — West Coast Swing", role:"Attended", date:"2022" },
      { country:"Singapore", city:"Singapore", lat:1.3521, lng:103.8198, title:"Bachata Temptation", role:"Attended", date:"2022" },

      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Certified Personal Trainer — Celebrity Fitness", role:"Attended", date:"2023" },
      { country:"Singapore", city:"Singapore", lat:1.3521, lng:103.8198, title:"Asian Open — West Coast Swing", role:"Attended", date:"2021" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Kizomba with François — Assistant Instructor", role:"Taught", date:"2021" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Latin American Festival — Performance", role:"Performed", date:"2021" },
      { country:"Germany", city:"Berlin", lat:52.5200, lng:13.4050, title:"ART.SEE.ASIA — Deutsche Welle (Guest Performance)", role:"Performed", date:"2021" },

      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Short & Sweet KLPAC — Choreographer & Performer (When Love Arrives)", role:"Performed", date:"2020" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"MyDance Alliance / ASK Dance Company Workshop — Contemporary", role:"Attended", date:"2019" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Short & Sweet KLPAC — Performer (Lady Boss by Mohd Zulkarnain)", role:"Performed", date:"2019" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Coca-Cola Malaysia — Choreographer & Event Coordinator", role:"Coordinated", date:"2018" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Coca-Cola Malaysia — Choreographer & Event Coordinator", role:"Coordinated", date:"2019" },
      { country:"Malaysia", city:"Kuala Lumpur", lat:3.1390, lng:101.6869, title:"Short & Sweet KLPAC — Choreographer & Performer (PENNE)", role:"Performed", date:"2018" }
    ];

    // ISO_A3 mapping (must match properties.ISO_A3 in your pasted GeoJSON)
    const ISO_FROM_NAME = {
      "Georgia":"GEO","Latvia":"LVA","Malaysia":"MYS","France":"FRA","Hungary":"HUN",
      "Poland":"POL","Sweden":"SWE","Netherlands":"NLD","Denmark":"DNK","Singapore":"SGP","Germany":"DEU"
    };
    // Normalize names so "France", "FRANCE", "France  " all match
function normalizeName(s) {
  return String(s || "")
    .normalize("NFKD")
    .replace(/[^\w]+/g, " ")
    .trim()
    .toUpperCase();
}

// One ISO extractor to rule them all
function getISOfromFeature(f) {
  const p = f && f.properties ? f.properties : {};
  const val =
    p.ISO_A3 ||
    p["ISO3166-1-Alpha-3"] ||
    p.ADM0_A3 ||
    p.SOV_A3 ||
    p.A3_UN ||
    p.A3 ||
    p.iso_a3 ||
    p.adm0_a3 ||
    p.sov_a3;
  return (val || "").toString().toUpperCase();
}

// Get a reasonable display name from the feature
function getNameFromFeature(f) {
  const p = f && f.properties ? f.properties : {};
  const name =
    p.ADMIN || p.ADMIN_NAME || p.NAME_EN || p.NAME || p.name || p.SOVEREIGNT || p.SOVEREIGNTY;
  return normalizeName(name);
}

// Build the visible ISO set (from your events)
function isoSetFromGroups(groupsObj) {
  const iso = new Set();
  Object.values(groupsObj).forEach(g => {
    const code = ISO_FROM_NAME[g.country];
    if (code) iso.add(code.toUpperCase());
  });
  return iso;
}

// Build the visible country-name set (from your events)
function nameSetFromGroups(groupsObj) {
  const names = new Set();
  Object.values(groupsObj).forEach(g => {
    names.add(normalizeName(g.country));
  });
  return names;
}

    // --- Map ---
    const map = L.map('map', { worldCopyJump: true, minZoom: 2 }).setView([20, 10], 2);
    // --- Make sure the map sizes correctly when shown inside a modal/iframe
function kickMapSize() {
  try { map.invalidateSize(true); } catch(e) {}
}
// one-time kick shortly after startup
setTimeout(kickMapSize, 50);     // quick
setTimeout(kickMapSize, 300);    // after fonts/layout settle
// kick on window resizes and when the tab becomes visible again
window.addEventListener('resize', kickMapSize);
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) kickMapSize();
});

    // You can swap tiles later; this one is light and clean:
    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png',
      { maxZoom: 19, attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);

    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
    const cityKey = rec => `${rec.country}—${rec.city}`;

    // Group by city
    const grouped = {};
    for (const e of EVENTS) {
      const key = cityKey(e);
      if (!grouped[key]) grouped[key] = { ...e, events: [] };
      grouped[key].events.push(e);
    }

    // Markers
    const cityIndex = {};
    Object.keys(grouped).forEach(key => {
      const g = grouped[key];
      const m = L.marker([g.lat, g.lng], { title: `${g.city}, ${g.country}` });
      m.bindPopup(makePopup(g), { maxWidth: 320 });
      cluster.addLayer(m);
      cityIndex[key] = m;
    });
    cluster.addTo(map);
    fitToMarkers();
    loadLocalCountries();
    
    // --- Exact-country highlights (offline from local file) ---
let COUNTRIES_GEOJSON = null;
let countriesLayer = null;

async function loadLocalCountries() {
  try {
    const res = await fetch('../countries.geojson');   // relative up one level
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    COUNTRIES_GEOJSON = await res.json();
    const isoAll  = isoSetFromGroups(grouped);
    const nameAll = nameSetFromGroups(grouped);
    rebuildCountriesLayer(isoAll, nameAll);

  } catch (e) {
    console.warn("Could not load local countries.geojson:", e);
  }
}

function rebuildCountriesLayer(visibleIsoSet, visibleNameSet) {
  if (!COUNTRIES_GEOJSON) return;

  if (countriesLayer) {
    countriesLayer.remove();
    countriesLayer = null;
  }

  // Optional: warn if any requested ISO is missing from the dataset
  try {
    const fileIsos  = new Set((COUNTRIES_GEOJSON.features || []).map(getISOfromFeature));
    const fileNames = new Set((COUNTRIES_GEOJSON.features || []).map(getNameFromFeature));
    const missingIso = [...visibleIsoSet].filter(c => !fileIsos.has(c));
    const missingByName = [...visibleNameSet].filter(n => !fileNames.has(n));
    if (missingIso.length)   console.warn("ISO not found in GeoJSON:", missingIso);
    if (missingByName.length) console.warn("Names not found in GeoJSON:", missingByName);
  } catch {}

  countriesLayer = L.geoJSON(COUNTRIES_GEOJSON, {
    filter: f => {
      const iso  = getISOfromFeature(f);
      const name = getNameFromFeature(f);
      return visibleIsoSet.has(iso) || visibleNameSet.has(name);
    },
    interactive: false,
    style: {
      color: '#2aa9ff',
      weight: 2,
      opacity: 0.95,
      fillColor: '#2aa9ff',
      fillOpacity: 0.45
    }
  });

  countriesLayer.addTo(map);
  countriesLayer.bringToBack();
}

    function makePopup(group) {
      const eventsHtml = group.events
        .sort((a,b) => (a.date||'').localeCompare(b.date||''))
        .map(ev => `
          <div class="popup-event">
            <div class="popup-title">${escapeHtml(ev.title)}</div>
            <small>${escapeHtml(ev.role)} • ${escapeHtml(ev.date || '')}</small>
          </div>
        `).join("");
      return `<div>
        <div><strong>${escapeHtml(group.city)}</strong>, ${escapeHtml(group.country)}</div>
        ${eventsHtml}
      </div>`;
    }

    function fitToMarkers() {
      const layers = cluster.getLayers();
      if (!layers.length) return;
      const bounds = L.latLngBounds(layers.map(l => l.getLatLng()));
      map.fitBounds(bounds.pad(0.2));
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // --- Sidebar + Filters ---
    const listEl  = document.getElementById('list');
    const yearEl  = document.getElementById('yearFilter');
    const roleEl  = document.getElementById('roleFilter');
    const searchEl= document.getElementById('search');

    // Years
    const years = [...new Set(EVENTS.map(e => (e.date||"").slice(0,4)).filter(Boolean))].sort();
    years.forEach(y => { const o=document.createElement('option'); o.value=y; o.textContent=y; yearEl.appendChild(o); });

    // Roles
    const roles = [...new Set(EVENTS.map(e => e.role).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    roles.forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; roleEl.appendChild(o); });

    function renderList() {
      const q = searchEl.value.trim().toLowerCase();
      const y = yearEl.value;
      const r = roleEl.value;

      const filtered = {};
      for (const key of Object.keys(grouped)) {
        const g = grouped[key];
        const evs = g.events.filter(ev => {
          const matchesYear = !y || (ev.date||"").startsWith(y);
          const matchesRole = !r || (ev.role === r);
          const matchesQ = !q || [ev.title, ev.city, ev.country, ev.role, ev.date].some(f => (f||"").toLowerCase().includes(q));
          return matchesYear && matchesRole && matchesQ;
        });
        if (evs.length) filtered[key] = { ...g, events: evs };
      }

      // Chips
      const allEvents = Object.values(filtered).flatMap(g => g.events);
      document.getElementById('totalEvents').textContent   = allEvents.length;
      document.getElementById('totalCities').textContent   = Object.keys(filtered).length;
      document.getElementById('totalCountries').textContent= new Set(Object.values(filtered).map(g => g.country)).size;

      // List
      const byCountry = {};
      for (const key of Object.keys(filtered)) {
        const g = filtered[key];
        if (!byCountry[g.country]) byCountry[g.country] = [];
        byCountry[g.country].push(g);
      }
      const countryNames = Object.keys(byCountry).sort((a,b)=>a.localeCompare(b));

      listEl.innerHTML = countryNames.map(country => {
        const cities = byCountry[country].sort((a,b)=>a.city.localeCompare(b.city))
          .map(g => `
            <div class="city">
              <h4>
                ${escapeHtml(g.city)}
                <a class="focus" href="#" data-target="${cityKey(g)}" title="Show on map">focus</a>
              </h4>
              ${g.events.map(ev => `
                <div class="event">
                  <div><strong>${escapeHtml(ev.title)}</strong></div>
                  <small>${escapeHtml(ev.role)} • ${escapeHtml(ev.date||'')}</small>
                </div>
              `).join("")}
            </div>
          `).join("");

        return `<div class="country">
          <h3>${escapeHtml(country)}</h3>
          ${cities}
        </div>`;
      }).join("");

      // Focus links — center marker and open popup without auto-pan
listEl.querySelectorAll('a.focus').forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    const key = a.getAttribute('data-target');
    const marker = cityIndex[key];
    if (!marker) return;

    const latlng = marker.getLatLng();

    // 1) Center the map on the marker (choose a zoom that feels right)
    const targetZoom = Math.max(map.getZoom(), 7);
    map.setView(latlng, targetZoom, { animate: true });

    // 2) Open the popup without letting Leaflet auto-pan it away from center
    const popup = marker.getPopup();
    if (popup) {
      const prev = popup.options.autoPan;
      popup.options.autoPan = false;   // disable autopan for this open
      marker.openPopup();
      popup.options.autoPan = prev;    // restore original behavior
    }
  });
});

      // Update exact-country highlights
      const isoFiltered  = isoSetFromGroups(filtered);
      const nameFiltered = nameSetFromGroups(filtered);
      rebuildCountriesLayer(isoFiltered, nameFiltered);


      // Sync markers
      cluster.clearLayers();
      Object.keys(filtered).forEach(k => cluster.addLayer(cityIndex[k]));
    }

    searchEl.addEventListener('input', renderList);
    yearEl.addEventListener('change', renderList);
    roleEl.addEventListener('change', renderList);
    renderList();
  });
  </script>
</body>
</html>
